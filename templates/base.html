<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}–°–∏—Å—Ç–µ–º–∞ —Ä–µ–º–æ–Ω—Ç–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíª</text></svg>">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('dashboard') }}" class="logo">
                <i class="fas fa-laptop-medical"></i> –†–µ–º–æ–Ω—Ç –ü–ö
                <span class="logo-sub">–ö–æ–ª–ª–µ–¥–∂</span>
            </a>
            
            <div class="nav-links">
                {% if session.user_id %}
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
                    <div class="user-info">
                        <div class="user-avatar">
                            {% if session.role == 'admin' %}
                                <i class="fas fa-crown"></i>
                            {% elif session.role == 'technician' %}
                                <i class="fas fa-tools"></i>
                            {% else %}
                                <i class="fas fa-user"></i>
                            {% endif %}
                        </div>
                        <div class="user-details">
                            <span class="user-name">{{ session.full_name }}</span>
                            <span class="user-role {{ session.role }}">
                                {% if session.role == 'admin' %}
                                    –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                {% elif session.role == 'technician' %}
                                    –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
                                {% else %}
                                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏ -->
                    <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                        <i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è
                    </a>
                    
                    <a href="{{ url_for('view_requests') }}" class="nav-link {% if request.endpoint == 'view_requests' %}active{% endif %}">
                        <i class="fas fa-list"></i> –ó–∞—è–≤–∫–∏
                        {% if session.role in ['admin', 'technician'] %}
                            <span class="nav-badge" id="pending-count"></span>
                        {% endif %}
                    </a>
                    
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ -->
                    {% if session.role == 'user' %}
                    <a href="{{ url_for('create_request') }}" class="nav-link {% if request.endpoint == 'create_request' %}active{% endif %}">
                        <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </a>
                    {% endif %}
                    
                    <!-- –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: –º–æ–∏ –∑–∞–¥–∞—á–∏ -->
                    {% if session.role == 'technician' %}
                    <a href="{{ url_for('technician_tasks') }}" class="nav-link {% if request.endpoint == 'technician_tasks' %}active{% endif %}">
                        <i class="fas fa-tasks"></i> –ú–æ–∏ –∑–∞–¥–∞—á–∏
                    </a>
                    {% endif %}
                    
                    <!-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                    {% if session.role == 'admin' %}
                    <a href="{{ url_for('create_user') }}" class="nav-link {% if request.endpoint == 'create_user' %}active{% endif %}">
                        <i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    </a>
                    {% endif %}
                    
                    <!-- –í—ã—Ö–æ–¥ -->
                    <a href="{{ url_for('logout') }}" class="nav-link logout-btn">
                        <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                    </a>
                {% endif %}
            </div>
            
            <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ–µ) -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <h3>–ú–µ–Ω—é</h3>
            <button class="close-mobile-menu" id="closeMobileMenu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-menu-links">
            {% if session.user_id %}
                <div class="mobile-user-info">
                    <div class="mobile-user-avatar">
                        {% if session.role == 'admin' %}
                            <i class="fas fa-crown"></i>
                        {% elif session.role == 'technician' %}
                            <i class="fas fa-tools"></i>
                        {% else %}
                            <i class="fas fa-user"></i>
                        {% endif %}
                    </div>
                    <div class="mobile-user-details">
                        <span class="mobile-user-name">{{ session.full_name }}</span>
                        <span class="mobile-user-role {{ session.role }}">
                            {% if session.role == 'admin' %}
                                –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                            {% elif session.role == 'technician' %}
                                –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
                            {% else %}
                                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <a href="{{ url_for('dashboard') }}" class="mobile-nav-link">
                    <i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è
                </a>
                
                <a href="{{ url_for('view_requests') }}" class="mobile-nav-link">
                    <i class="fas fa-list"></i> –ó–∞—è–≤–∫–∏
                </a>
                
                {% if session.role == 'user' %}
                <a href="{{ url_for('create_request') }}" class="mobile-nav-link">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                </a>
                {% endif %}
                
                {% if session.role == 'technician' %}
                <a href="{{ url_for('technician_tasks') }}" class="mobile-nav-link">
                    <i class="fas fa-tasks"></i> –ú–æ–∏ –∑–∞–¥–∞—á–∏
                </a>
                {% endif %}
                
                {% if session.role == 'admin' %}
                <a href="{{ url_for('create_user') }}" class="mobile-nav-link">
                    <i class="fas fa-user-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </a>
                {% endif %}
                
                <a href="{{ url_for('logout') }}" class="mobile-nav-link logout-btn">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                </a>
            {% endif %}
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'user_created' %}
                    <div class="user-created-alert">
                        <i class="fas fa-check-circle"></i>
                        <div class="alert-content">
                            <h4>{{ message.title }}</h4>
                            <p>{{ message.message }}</p>
                            <div class="user-credentials">
                                <table>
                                    <tr>
                                        <td>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</td>
                                        <td>{{ message.username }}</td>
                                    </tr>
                                    <tr>
                                        <td>–ü–∞—Ä–æ–ª—å:</td>
                                        <td>{{ message.password }}</td>
                                    </tr>
                                    <tr>
                                        <td>–†–æ–ª—å:</td>
                                        <td>{{ message.role }}</td>
                                    </tr>
                                </table>
                                <p class="credentials-note">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ! –û–Ω–∏ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.
                                </p>
                            </div>
                        </div>
                        <button class="close-alert" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% else %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-{% if category == 'success' %}check-circle{% elif category == 'danger' %}exclamation-circle{% elif category == 'info' %}info-circle{% else %}bell{% endif %}"></i>
                        <span>{{ message }}</span>
                        <button class="close-alert" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- –ë–ª–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        {% block content %}{% endblock %}
    </div>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-logo">
                <i class="fas fa-laptop-medical"></i>
                <span>–°–∏—Å—Ç–µ–º–∞ —Ä–µ–º–æ–Ω—Ç–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤</span>
            </div>
            <div class="footer-info">
                <p>¬© 2024 –ö–æ–ª–ª–µ–¥–∂. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <p class="footer-version">–í–µ—Ä—Å–∏—è 1.0.0</p>
            </div>
            <div class="footer-links">
                <a href="#" class="footer-link"><i class="fas fa-question-circle"></i> –ü–æ–º–æ—â—å</a>
                <a href="#" class="footer-link"><i class="fas fa-envelope"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
                <a href="#" class="footer-link"><i class="fas fa-shield-alt"></i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</a>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const closeMobileMenuBtn = document.getElementById('closeMobileMenu');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.add('show');
                });
                
                closeMobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.remove('show');
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
                document.addEventListener('click', function(event) {
                    if (!mobileMenu.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        mobileMenu.classList.remove('show');
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫
            function updatePendingCount() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                var userRole = "{{ session.role if session.user_id else '' }}";
                if (userRole === 'admin' || userRole === 'technician') {
                    fetch('/api/requests')
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            const pendingCount = data.filter(function(req) {
                                return req.status === 'pending';
                            }).length;
                            const badge = document.getElementById('pending-count');
                            if (badge) {
                                if (pendingCount > 0) {
                                    badge.textContent = pendingCount;
                                    badge.style.display = 'inline-flex';
                                } else {
                                    badge.style.display = 'none';
                                }
                            }
                        })
                        .catch(function(error) {
                            console.error('–û—à–∏–±–∫–∞:', error);
                        });
                }
            }
            
            // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            updatePendingCount();
            setInterval(updatePendingCount, 30000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Å—ã–ª–∫–∏
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(function(link) {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert:not(.user-created-alert)');
                alerts.forEach(function(alert) {
                    alert.style.opacity = '0';
                    setTimeout(function() {
                        alert.remove();
                    }, 300);
                });
            }, 5000);
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        function confirmAction(message) {
            return confirm(message || '–í—ã —É–≤–µ—Ä–µ–Ω—ã?');
        }
    </script>
</body>
</html>